% !TEX spellcheck = en_US
% !TEX spellcheck = LaTeX
%\documentclass[a4paper,10pt,english]{article}
\documentclass[all-lectures.tex]{subfiles}
%\input{header}
%\title{Lecture 01: Poisson Processes}
%\author{}
\newcommand*{\QEDB}{\hfill\ensuremath{\square}}%
\setcounter{chapter}{7}
\usepackage{enumitem}
\begin{document}
%\maketitle

%\chapter{Martingales}
\setcounter{section}{4}
\setcounter{subsection}{1}

\section*{\centering{Lecture 27 \linebreak }}
\subsection{Networks of quaasireversible queues (contd.)}
Quasireversibility implies that $(1)$ $\{N^+_c(t)\}\ \forall c\}$ are independent Poissn processes and $N_c^-(t)$  and $(2)$ $\{N^-_c(t)\}\ \forall c\}$ are independent Poissn processes.

\indent Let $X_t = (X_t(1),X_t(2),\dots,X_t(N))$ denote the state of the system with $N$ quasireversible queues and $X_t(i)$ denotes the state of $i^{th}$ queue at time $t$. Note that there is no requirement for all the queues to be of the same type. The queues can be of different type as long they are quasireversible in isolation. 

\begin{thm}
If $\rho_i < 1\ \forall i \in {1,2,\dots,N}$, then $X_t$ has a stationary distribution $\pi $of the form 
\begin{align*}
\pi(x(1),x(2),\dots,x(N)) = \prod_{i}^N \pi_i(x(i))
\end{align*}
where $\pi_i$ is the stationary distribution of queue $i$.
\end{thm}
\begin{proof}
We show that $\pi Q = 0$ for $Q$ representing the rate matrix for the process $X_t$. We claim that $X_t$ is itself a quasireversible process by noting the following: 
\begin{itemize}
\item External arrivals are independent Poisson processes. 
\item Future arrivals, $X_t$ and past departures are independent. 
\end{itemize}
The reversed process $\tilde{X}_t = X_{T-t}$ for some fixed time $T$. We have 
\begin{align*}
\pi(i) \tilde{Q}(i,j) = \pi(j) Q(j,i).
\end{align*}
Here, $\tilde{Q}$ corresponds to the another quasireversible system with parameters 
\begin{align*}
\tilde{p}_{ij}^{cd} &= \frac{\overline{\lambda}_j^d}{\overline{\lambda}_i^c} p_{ji}^{dc}. \qedhere
\end{align*} 
\end{proof}
We can compute the mean queue length or the mean number of customers from the above theorem. The mean sojourn time $\E[S]$ can be deduced from apllying Little's law to the whole system - $\E[S] = \lambda \E[q]$ where $\E[q]$ is the mean number of customers in the system and $\lambda = \sum_i \lambda_i$ is the total external arrival rate into the system. Further, Little's law can be applied to each class of customers individually. The mean sojourn time of a class $c$ customer $\E[S_c] = \lambda_c \E[q_c]$ where $\E[q_c]$ is the mean number of customers of class $c$ in the system. 

\indent Consider a tandem of $N$ $M/M/1$ queues with service rate $\mu_i$ at queue $i$. Let the random variable $S^i$ denote the sojourn time of a customer in queue $i$. We know that departure process of queue $1$ is Poisson of the rate $\lambda$. This is also the arrival process of queue $2$ which is again $M/M/1$. Therefore, the arrival and departure process for all queues is Poisson with rate $\lambda$. If an arriving customer at queue $i$ sees $n$ customers already in queue, then $S^i = \sum_{i=1}^{n+1} s_k$ where $s_k$s are service times which are i.i.d. with exponential distribution of mean $1/\mu_i$. By PASTA, the probability that an arriving customer sees $n$ customers already in the queue is equal to the stationary probability of $n$ customers in the queue. We can now compute distribution of $S^i$ as follows.
\begin{align*}
\P\{S^i \leq x\} &= \sum_{n=0}^{n=\infty} \P\{S^i \leq x | q_i = n\} \P_{\pi}\{ q_i = n\} \\
&= \sum_{n=0}^{n=\infty} \P\{S^i \leq x | q_i = n\} \rho_i^n (1-\rho_i) && \text{(PASTA)}.
\end{align*}
We can show that the above quantity is an exponential distribution with mean $1/(\mu_i - \lambda)$. This is applicable to all the queues. The total sojourn time is $S = \sum_{i=1}^N S^i$. Furthermore, it can also be shown that $\{S^i, \forall i\}$ are independent random variables. \\
\indent The above results hold true for a general network of quasireversible queues. This is summarized below. 
\begin{prop}
For a network of quasireversible queues, the sojourn times of customers in queue $\{S^1,S^2,\dots,S^N\}$ are independent and $S^i$ is exponentially distributed with mean $1/(\mu_i - \lambda_i)$.
\end{prop}

Consider an $M/M/1$ queue with feedback. A customer after service re-enters the queue with probability $p$ and exits the system with probability $1-p$. Let the external arrival rate be $\lambda$ and the aggregate arrival rate (including from feedback) be $\overline{\lambda}$ We have the relation $\overline{\lambda} = \lambda + p \overline{\lambda}$ from which we find
\begin{align*}
\overline{\lambda} = \frac{\lambda}{1-p}.
\end{align*}
The aggregate arrival process is not a Poisson process. We can check this as follows. Let $N_t$ denote the aggregate arrival process. For small enough $\epsilon >0$,
\begin{align*}
\P\{N_{t+\epsilon} \geq N_t + 1\} = \lambda \epsilon + o(\epsilon) + p \mu \epsilon \P_{\pi}\{q_t > 0\}
\end{align*}
where $\mu \epsilon \P_{\pi}\{q_t > 0\}$ denotes the probability of a customer finishing service at time $t$. We also have \begin{align*}
\P\{N_{t+\epsilon} \geq N_t + 1| N_{t} \geq N_{t-\epsilon} + 1\} &= \lambda \epsilon + o(\epsilon) + p \mu \epsilon.
\end{align*}
The above equation follows from the fact that the event $\{N_{t} \geq N_{t-\epsilon} + 1\}$ implies $\{q_t > 0\}$. From these two equations, we see that $\P\{N_{t+\epsilon} \geq N_t + 1| N_{t} \geq N_{t-\epsilon} + 1\} \neq \P\{N_{t+\epsilon} \geq N_t + 1\}$. This shows that $N_t$ is not an independent increment process and hence cannot be Poisson. 

In an open quasireversible network, the aggregate arrival process at a node is not Poisson if there is non-zero probability of a customer entering the same node. For such nodes, the departure process will not also not be Poisson. 

Consider again an $M/M/1$ queue. Define 
\begin{align*}
q_t &= \text{ queue length at time $t$} \\
q_n^A &= \text{queue length just before $n^{th}$ arrival} \\
q_n^D &= \text{queue length just after $n^{th}$ departure} \\
\tilde{q}_n^A &= \text{queue length just after $n^{th}$ arrival} \\
\end{align*}
Under stationarity, we have shown that $q^A_n \stackrel{d}{=} q_t$ (PASTA) and $q^D_n \stackrel{d}{=} q_t$ (rate conservation law) for $GI/GI/1$ queue. It is important to consider 'just before' and 'just after'  in the above statements. For example $\P\{\tilde{q}^A_n = 0\} =0$ as there is always atleast one customer soon after a new arrival. But, the stationary probability of empty system is $1-\rho$. That is, $\P\{\tilde{q}^A_n = 0\} \neq \P\{q_t = 0\}$.

To explore further consider a tandem of two queues. Let $S_n(i)$ be the time instant of an arrival into queue $i$. $q_{S_n(2)+}^D(1)$ denotes the length of queue $1$ just after a departure from queue $1$. $q_{S_n(2)-}^A(2)$ denotes the length of queue $2$ just before $n^{th}$ arrival into queue $2$. The distribution of $(q_{S_n(2)+}^D(1),q_{S_n(2)-}^A(2))$ under stationarity is 
\begin{align*}
\pi(n_1,n_2) = \rho_1^{n_1} (1-\rho_1) \rho_2^{n_2} (1-\rho_2).
\end{align*}
The above discussion is true in an open network of quasireversible queues. 
\begin{thm}
Let $X_t = (X_t(1),X_t(2),\dots,X_t(N))$ be the state of an open network of $N$ quasireversible queues. Let $\pi$ be the stationary distribution of $X_t$. For a customer moving from queue $i$ to queue $j$
\begin{align*}
(X_{S_n}(1),\dots,X_{S_n}(i),\dots,X_{S_n-}(j),\dots,X_{S_n}(N)) \stackrel{d}{=} \pi
\end{align*}
and
\begin{align*}
\P\{X_{S_n}(1)=x_1,\dots,X_{S_n}(i)=x_i,\dots,X_{S_n}(j) =x_j,\dots,X_{S_n}(N)=x_N\} 
= \pi(x_1,\dots,x_i,\dots,x_j -1,\dots,x_N). \QEDB
\end{align*}
\end{thm}

\textit{Restriction of Markov chain to a subset of states:} Consider $M/M/1/N$ queue with finite buffer of length $N$. The queue length process $\{q_t\}$ is a finite state space, irreducible Markov chain. It is always positive recurrent with stationary distribtion $\pi_N$. The stationary distribution satisfies $\pi_N Q = 0$ where $Q$ is the rate martix given by $Q(i,i+1) = \lambda$, $Q(i,i-1) = \mu$ and $Q(0,1) = \lambda$. We can derive this another way by considering Markov chain corresponding to $M/M/1/\infty$ as follows -
\begin{align*}
\pi_{N}(n) = \begin{cases}
	\frac{\pi_{\infty}(n)}{\sum_{k=0}^{N} \pi_{\infty}(k)} & \text{ for } n \in \{1,2,\dots,N\}. \\
	0 & \text{ otherwise}
	\end{cases}
\end{align*}
In general if $S$ is the state space of a Markov chain $\{X_t\}$ with rate matrix $Q$ and stationary distribution $\pi$, we can limit the Markov chain to a subset $A \subset S$ and obtain the corresponding stationary distribution as 
\begin{align*}
\pi_A(i) = \begin{cases} 
			\frac{\pi(i)}{\sum_{j \in A} \pi(j)} & \text{ if} j \in A \\
			0 & \text{ if } j \notin A \\
			\end{cases}
\end{align*}
\end{document}